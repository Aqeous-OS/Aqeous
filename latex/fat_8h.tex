\hypertarget{fat_8h}{}\section{Experimental Edition/\+Source/vfs/fat.h File Reference}
\label{fat_8h}\index{Experimental Edition/\+Source/vfs/fat.\+h@{Experimental Edition/\+Source/vfs/fat.\+h}}
{\ttfamily \#include $<$stdint.\+h$>$}\\*
{\ttfamily \#include $<$vfs.\+h$>$}\\*
Include dependency graph for fat.\+h\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=189pt]{fat_8h__incl}
\end{center}
\end{figure}
This graph shows which files directly or indirectly include this file\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=187pt]{fat_8h__dep__incl}
\end{center}
\end{figure}
\subsection*{Data Structures}
\begin{DoxyCompactItemize}
\item 
struct \hyperlink{struct__DIRECTORY}{\+\_\+\+D\+I\+R\+E\+C\+T\+O\+RY}
\item 
struct \hyperlink{struct__MOUNT__INFO}{\+\_\+\+M\+O\+U\+N\+T\+\_\+\+I\+N\+FO}
\end{DoxyCompactItemize}
\subsection*{Typedefs}
\begin{DoxyCompactItemize}
\item 
typedef struct \hyperlink{struct__DIRECTORY}{\+\_\+\+D\+I\+R\+E\+C\+T\+O\+RY} \hyperlink{fat_8h_a664f8eb509181bf2375e9d4c850ffdb9}{D\+I\+R\+E\+C\+T\+O\+RY}
\item 
typedef struct \hyperlink{struct__DIRECTORY}{\+\_\+\+D\+I\+R\+E\+C\+T\+O\+RY} $\ast$ \hyperlink{fat_8h_a4323b2f02c25bb1e6d8cd70b276ceb80}{P\+D\+I\+R\+E\+C\+T\+O\+RY}
\item 
typedef struct \hyperlink{struct__MOUNT__INFO}{\+\_\+\+M\+O\+U\+N\+T\+\_\+\+I\+N\+FO} \hyperlink{fat_8h_a1cf1a8e619a9ff768b087060d6fb4291}{M\+O\+U\+N\+T\+\_\+\+I\+N\+FO}
\item 
typedef struct \hyperlink{struct__MOUNT__INFO}{\+\_\+\+M\+O\+U\+N\+T\+\_\+\+I\+N\+FO} $\ast$ \hyperlink{fat_8h_a05f35d48f3e91cffc8a8e55194ef41ab}{P\+M\+O\+U\+N\+T\+\_\+\+I\+N\+FO}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{vfs_8h_a175abb747ea3b78aa8da87355dcec473}{F\+I\+LE} \hyperlink{fat_8h_a8acd9d04fdfc31b2e4b2e7c232d2b3be}{fsys\+Fat\+Directory} (const char $\ast$Directory\+Name)
\item 
void \hyperlink{fat_8h_a5be760edb30889bc597ea9ef5e81eb5a}{fsys\+Fat\+Read} (\hyperlink{vfs_8h_ad326c846895d1e06bc4c2228bf864968}{P\+F\+I\+LE} \hyperlink{structfile}{file}, unsigned char $\ast$Buffer, unsigned int Length)
\item 
\hyperlink{vfs_8h_a175abb747ea3b78aa8da87355dcec473}{F\+I\+LE} \hyperlink{fat_8h_a3b2ffc78448b02fa4dda810701140f10}{fsys\+Fat\+Open} (const char $\ast$File\+Name)
\item 
void \hyperlink{fat_8h_a26a6893bcd8a0bcd32572b180f9f24c2}{fsys\+Fat\+Initialize} ()
\item 
void \hyperlink{fat_8h_a7509c582754c138d385df81ebdb33249}{fsys\+Fat\+Mount} ()
\end{DoxyCompactItemize}


\subsection{Typedef Documentation}
\index{fat.\+h@{fat.\+h}!D\+I\+R\+E\+C\+T\+O\+RY@{D\+I\+R\+E\+C\+T\+O\+RY}}
\index{D\+I\+R\+E\+C\+T\+O\+RY@{D\+I\+R\+E\+C\+T\+O\+RY}!fat.\+h@{fat.\+h}}
\subsubsection[{\texorpdfstring{D\+I\+R\+E\+C\+T\+O\+RY}{DIRECTORY}}]{\setlength{\rightskip}{0pt plus 5cm}typedef struct {\bf \+\_\+\+D\+I\+R\+E\+C\+T\+O\+RY} {\bf D\+I\+R\+E\+C\+T\+O\+RY}}\hypertarget{fat_8h_a664f8eb509181bf2375e9d4c850ffdb9}{}\label{fat_8h_a664f8eb509181bf2375e9d4c850ffdb9}
\index{fat.\+h@{fat.\+h}!M\+O\+U\+N\+T\+\_\+\+I\+N\+FO@{M\+O\+U\+N\+T\+\_\+\+I\+N\+FO}}
\index{M\+O\+U\+N\+T\+\_\+\+I\+N\+FO@{M\+O\+U\+N\+T\+\_\+\+I\+N\+FO}!fat.\+h@{fat.\+h}}
\subsubsection[{\texorpdfstring{M\+O\+U\+N\+T\+\_\+\+I\+N\+FO}{MOUNT_INFO}}]{\setlength{\rightskip}{0pt plus 5cm}typedef struct {\bf \+\_\+\+M\+O\+U\+N\+T\+\_\+\+I\+N\+FO} {\bf M\+O\+U\+N\+T\+\_\+\+I\+N\+FO}}\hypertarget{fat_8h_a1cf1a8e619a9ff768b087060d6fb4291}{}\label{fat_8h_a1cf1a8e619a9ff768b087060d6fb4291}
Filesystem mount info \index{fat.\+h@{fat.\+h}!P\+D\+I\+R\+E\+C\+T\+O\+RY@{P\+D\+I\+R\+E\+C\+T\+O\+RY}}
\index{P\+D\+I\+R\+E\+C\+T\+O\+RY@{P\+D\+I\+R\+E\+C\+T\+O\+RY}!fat.\+h@{fat.\+h}}
\subsubsection[{\texorpdfstring{P\+D\+I\+R\+E\+C\+T\+O\+RY}{PDIRECTORY}}]{\setlength{\rightskip}{0pt plus 5cm}typedef struct {\bf \+\_\+\+D\+I\+R\+E\+C\+T\+O\+RY} $\ast$ {\bf P\+D\+I\+R\+E\+C\+T\+O\+RY}}\hypertarget{fat_8h_a4323b2f02c25bb1e6d8cd70b276ceb80}{}\label{fat_8h_a4323b2f02c25bb1e6d8cd70b276ceb80}
\index{fat.\+h@{fat.\+h}!P\+M\+O\+U\+N\+T\+\_\+\+I\+N\+FO@{P\+M\+O\+U\+N\+T\+\_\+\+I\+N\+FO}}
\index{P\+M\+O\+U\+N\+T\+\_\+\+I\+N\+FO@{P\+M\+O\+U\+N\+T\+\_\+\+I\+N\+FO}!fat.\+h@{fat.\+h}}
\subsubsection[{\texorpdfstring{P\+M\+O\+U\+N\+T\+\_\+\+I\+N\+FO}{PMOUNT_INFO}}]{\setlength{\rightskip}{0pt plus 5cm}typedef struct {\bf \+\_\+\+M\+O\+U\+N\+T\+\_\+\+I\+N\+FO} $\ast$ {\bf P\+M\+O\+U\+N\+T\+\_\+\+I\+N\+FO}}\hypertarget{fat_8h_a05f35d48f3e91cffc8a8e55194ef41ab}{}\label{fat_8h_a05f35d48f3e91cffc8a8e55194ef41ab}


\subsection{Function Documentation}
\index{fat.\+h@{fat.\+h}!fsys\+Fat\+Directory@{fsys\+Fat\+Directory}}
\index{fsys\+Fat\+Directory@{fsys\+Fat\+Directory}!fat.\+h@{fat.\+h}}
\subsubsection[{\texorpdfstring{fsys\+Fat\+Directory(const char $\ast$\+Directory\+Name)}{fsysFatDirectory(const char *DirectoryName)}}]{\setlength{\rightskip}{0pt plus 5cm}{\bf F\+I\+LE} fsys\+Fat\+Directory (
\begin{DoxyParamCaption}
\item[{const char $\ast$}]{Directory\+Name}
\end{DoxyParamCaption}
)}\hypertarget{fat_8h_a8acd9d04fdfc31b2e4b2e7c232d2b3be}{}\label{fat_8h_a8acd9d04fdfc31b2e4b2e7c232d2b3be}
Locates file or directory in root directory get 8.\+3 directory name

14 sectors per directory

read in sector of root directory

get directory info

16 entries per sector

get current filename

find a match?

found it, set up file info

set file type

return file

go to next directory

unable to find file 

Definition at line 69 of file fat.\+c.


\begin{DoxyCode}
69                                                   \{
70 
71     \hyperlink{struct__FILE}{FILE} \hyperlink{structfile}{file};
72     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char}* buf;
73     \hyperlink{struct__DIRECTORY}{PDIRECTORY} directory;
74 \textcolor{comment}{}
75 \textcolor{comment}{    //! get 8.3 directory name}
76 \textcolor{comment}{}    \textcolor{keywordtype}{char} DosFileName[11];
77     \hyperlink{fat_8c_a2bb8e1db0f8de852cf60d852d08082d8}{ToDosFileName} (DirectoryName, DosFileName, 11);
78     DosFileName[11]=0;
79 \textcolor{comment}{}
80 \textcolor{comment}{    //! 14 sectors per directory}
81 \textcolor{comment}{}    \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} sector=0; sector<14; sector++) \{
82 \textcolor{comment}{}
83 \textcolor{comment}{        //! read in sector of root directory}
84 \textcolor{comment}{}        buf = (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char}*) flpydsk\_read\_sector (\hyperlink{fat_8c_a48ba5e095fe5a8cbc25c65810d0460ee}{\_MountInfo}.
      \hyperlink{struct__MOUNT__INFO_aeccc0a73a2a1f4d2a55cd938461bcd45}{rootOffset} + sector );
85 \textcolor{comment}{}
86 \textcolor{comment}{        //! get directory info}
87 \textcolor{comment}{}        directory = (\hyperlink{fat_8h_a4323b2f02c25bb1e6d8cd70b276ceb80}{PDIRECTORY}) buf;
88 \textcolor{comment}{}
89 \textcolor{comment}{        //! 16 entries per sector}
90 \textcolor{comment}{}        \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i=0; i<16; i++) \{
91 \textcolor{comment}{}
92 \textcolor{comment}{            //! get current filename}
93 \textcolor{comment}{}            \textcolor{keywordtype}{char} name[11];
94             \hyperlink{string_8h_a776fdd36ddff3e9f4191ea47e0cbd5de}{memcpy} (name, directory->\hyperlink{struct__DIRECTORY_ab9950ebc3a840e0ad44f1aa3e2a05be6}{Filename}, 11);
95             name[11]=0;
96 \textcolor{comment}{}
97 \textcolor{comment}{            //! find a match?}
98 \textcolor{comment}{}            \textcolor{keywordflow}{if} (\hyperlink{string_8h_a34624c3be7459f677d90ae0ad046821a}{strcmp} (DosFileName, name) == 0) \{
99 \textcolor{comment}{}
100 \textcolor{comment}{                //! found it, set up file info}
101 \textcolor{comment}{}                \hyperlink{string_8h_a5d193b0ce634c4a4915378441a475c46}{strcpy} (file.\hyperlink{struct__FILE_a8b3af56d97e2466fd17f621e858f5997}{name}, DirectoryName);
102                 file.\hyperlink{struct__FILE_a72ed78f2e1d6b6fb661c1cb69ff288c7}{id}             = 0;
103                 file.\hyperlink{struct__FILE_a01dafa6a663b0705884e39c397706874}{currentCluster} = directory->\hyperlink{struct__DIRECTORY_a587e8955f97e6b4bac5f0f0778e08a4f}{FirstCluster};
104                 file.\hyperlink{struct__FILE_a3bc033e1420b222573c83e7305c0a8e1}{fileLength}     = directory->\hyperlink{struct__DIRECTORY_a7e15691413cbea31518a0d989de5ff0e}{FileSize};
105                 file.\hyperlink{struct__FILE_a9fece9dca128f88e081a2f9d879b5a70}{eof}            = 0;
106                 file.\hyperlink{struct__FILE_a3bc033e1420b222573c83e7305c0a8e1}{fileLength}     = directory->\hyperlink{struct__DIRECTORY_a7e15691413cbea31518a0d989de5ff0e}{FileSize};
107 \textcolor{comment}{}
108 \textcolor{comment}{                //! set file type}
109 \textcolor{comment}{}                \textcolor{keywordflow}{if} (directory->\hyperlink{struct__DIRECTORY_a01c9dc5d98375e3205b87b3188165413}{Attrib} == 0x10)
110                     file.\hyperlink{struct__FILE_a04f8186df85989c0b4bcdb010c1f5bb6}{flags} = \hyperlink{vfs_8h_ad7b6b046dfb46cc575f4b9dd418df545}{FS\_DIRECTORY};
111                 \textcolor{keywordflow}{else}
112                     file.\hyperlink{struct__FILE_a04f8186df85989c0b4bcdb010c1f5bb6}{flags} = \hyperlink{vfs_8h_a20f0a7ade1270e3923abafeb33864c55}{FS\_FILE};
113 \textcolor{comment}{}
114 \textcolor{comment}{                //! return file}
115 \textcolor{comment}{}                \textcolor{keywordflow}{return} file;
116             \}
117 \textcolor{comment}{}
118 \textcolor{comment}{            //! go to next directory}
119 \textcolor{comment}{}            directory++;
120         \}
121     \}
122 \textcolor{comment}{}
123 \textcolor{comment}{    //! unable to find file}
124 \textcolor{comment}{}    file.\hyperlink{struct__FILE_a04f8186df85989c0b4bcdb010c1f5bb6}{flags} = \hyperlink{vfs_8h_a48368ff8647905d8be3aff007908c35a}{FS\_INVALID};
125     \textcolor{keywordflow}{return} file;
126 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{fat_8h_a8acd9d04fdfc31b2e4b2e7c232d2b3be_cgraph}
\end{center}
\end{figure}


\index{fat.\+h@{fat.\+h}!fsys\+Fat\+Initialize@{fsys\+Fat\+Initialize}}
\index{fsys\+Fat\+Initialize@{fsys\+Fat\+Initialize}!fat.\+h@{fat.\+h}}
\subsubsection[{\texorpdfstring{fsys\+Fat\+Initialize()}{fsysFatInitialize()}}]{\setlength{\rightskip}{0pt plus 5cm}void fsys\+Fat\+Initialize (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}\hypertarget{fat_8h_a26a6893bcd8a0bcd32572b180f9f24c2}{}\label{fat_8h_a26a6893bcd8a0bcd32572b180f9f24c2}
Initialize filesystem initialize filesystem struct

register ourself to volume manager

mounr filesystem 

Definition at line 359 of file fat.\+c.


\begin{DoxyCode}
359                           \{
360 \textcolor{comment}{}
361 \textcolor{comment}{    //! initialize filesystem struct}
362 \textcolor{comment}{}    \hyperlink{string_8h_a5d193b0ce634c4a4915378441a475c46}{strcpy} (\hyperlink{fat_8c_a109013f4791cf6b8539dd3b20b3188d8}{\_FSysFat}.\hyperlink{struct__FILE__SYSTEM_a802d31f742c14deb2020c8bd6bcb4fdb}{Name}, \textcolor{stringliteral}{"FAT12"});
363     \hyperlink{fat_8c_a109013f4791cf6b8539dd3b20b3188d8}{\_FSysFat}.\hyperlink{struct__FILE__SYSTEM_a96097c4b444cc7c7cd110f8f8c56ed55}{Directory} = \hyperlink{fat_8c_a8acd9d04fdfc31b2e4b2e7c232d2b3be}{fsysFatDirectory};
364     \hyperlink{fat_8c_a109013f4791cf6b8539dd3b20b3188d8}{\_FSysFat}.\hyperlink{struct__FILE__SYSTEM_a5aa8d15979d91eec1ff97c4701594ff2}{Mount}     = \hyperlink{fat_8c_a7509c582754c138d385df81ebdb33249}{fsysFatMount};
365     \hyperlink{fat_8c_a109013f4791cf6b8539dd3b20b3188d8}{\_FSysFat}.\hyperlink{struct__FILE__SYSTEM_ae7183a7cfc938bbf1ed51aab2462b991}{Open}      = \hyperlink{fat_8c_a3b2ffc78448b02fa4dda810701140f10}{fsysFatOpen};
366     \hyperlink{fat_8c_a109013f4791cf6b8539dd3b20b3188d8}{\_FSysFat}.\hyperlink{struct__FILE__SYSTEM_a24dcbcc9b82e7395aa6b15ef3e36413c}{Read}      = \hyperlink{fat_8c_a5be760edb30889bc597ea9ef5e81eb5a}{fsysFatRead};
367     \hyperlink{fat_8c_a109013f4791cf6b8539dd3b20b3188d8}{\_FSysFat}.\hyperlink{struct__FILE__SYSTEM_a5595fce92d628028705b1ddd25d21e6f}{Close}     = \hyperlink{fat_8c_a7b4d8f1de0591bd809d75a8f9c32ed44}{fsysFatClose};
368 \textcolor{comment}{}
369 \textcolor{comment}{    //! register ourself to volume manager}
370 \textcolor{comment}{}    \hyperlink{vfs_8c_ad2fdcfdd1fc9e1f8a9f216334bd0c05b}{volRegisterFileSystem} ( &\hyperlink{fat_8c_a109013f4791cf6b8539dd3b20b3188d8}{\_FSysFat}, 0 );
371 \textcolor{comment}{}
372 \textcolor{comment}{    //! mounr filesystem}
373 \textcolor{comment}{}    \hyperlink{fat_8c_a7509c582754c138d385df81ebdb33249}{fsysFatMount} ();
374 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{fat_8h_a26a6893bcd8a0bcd32572b180f9f24c2_cgraph}
\end{center}
\end{figure}


\index{fat.\+h@{fat.\+h}!fsys\+Fat\+Mount@{fsys\+Fat\+Mount}}
\index{fsys\+Fat\+Mount@{fsys\+Fat\+Mount}!fat.\+h@{fat.\+h}}
\subsubsection[{\texorpdfstring{fsys\+Fat\+Mount()}{fsysFatMount()}}]{\setlength{\rightskip}{0pt plus 5cm}void fsys\+Fat\+Mount (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}\hypertarget{fat_8h_a7509c582754c138d385df81ebdb33249}{}\label{fat_8h_a7509c582754c138d385df81ebdb33249}
Mounts the filesystem Boot sector info

read boot sector

store mount info 

Definition at line 338 of file fat.\+c.


\begin{DoxyCode}
338                      \{
339 \textcolor{comment}{}
340 \textcolor{comment}{    //! Boot sector info}
341 \textcolor{comment}{}    \hyperlink{struct__BOOT__SECTOR}{PBOOTSECTOR} bootsector;
342 \textcolor{comment}{}
343 \textcolor{comment}{    //! read boot sector}
344 \textcolor{comment}{}    bootsector = (\hyperlink{bpb_8h_a636c12dde4f51ecf4486b3cf7c58f1d2}{PBOOTSECTOR}) flpydsk\_read\_sector (0);
345 \textcolor{comment}{}
346 \textcolor{comment}{    //! store mount info}
347 \textcolor{comment}{}    \hyperlink{fat_8c_a48ba5e095fe5a8cbc25c65810d0460ee}{\_MountInfo}.\hyperlink{struct__MOUNT__INFO_a0071bda2d72096f634544df8aacc3f32}{numSectors}     = bootsector->\hyperlink{struct__BOOT__SECTOR_afedc563717fbacc0ce2e3b2fa31384bc}{Bpb}.
      \hyperlink{struct__BIOS__PARAMATER__BLOCK_a98d94e48588132acbd65fedd4de95647}{NumSectors};
348     \hyperlink{fat_8c_a48ba5e095fe5a8cbc25c65810d0460ee}{\_MountInfo}.\hyperlink{struct__MOUNT__INFO_a1aa114acfe01f60c8a85fe7a01d5c96d}{fatOffset}      = 1;
349     \hyperlink{fat_8c_a48ba5e095fe5a8cbc25c65810d0460ee}{\_MountInfo}.\hyperlink{struct__MOUNT__INFO_a1c27dc07d9399da26e9836433514537e}{fatSize}        = bootsector->\hyperlink{struct__BOOT__SECTOR_afedc563717fbacc0ce2e3b2fa31384bc}{Bpb}.
      \hyperlink{struct__BIOS__PARAMATER__BLOCK_adc667cf101250030eb318e36b38487ea}{SectorsPerFat};
350     \hyperlink{fat_8c_a48ba5e095fe5a8cbc25c65810d0460ee}{\_MountInfo}.\hyperlink{struct__MOUNT__INFO_ade01217e0a9e58634a65b1279bbe95c6}{fatEntrySize}   = 8;
351     \hyperlink{fat_8c_a48ba5e095fe5a8cbc25c65810d0460ee}{\_MountInfo}.\hyperlink{struct__MOUNT__INFO_afacdf709c99a10da00c6859acd935334}{numRootEntries} = bootsector->\hyperlink{struct__BOOT__SECTOR_afedc563717fbacc0ce2e3b2fa31384bc}{Bpb}.
      \hyperlink{struct__BIOS__PARAMATER__BLOCK_a9d9f79e3acd72e08ff27fb471569c841}{NumDirEntries};
352     \hyperlink{fat_8c_a48ba5e095fe5a8cbc25c65810d0460ee}{\_MountInfo}.\hyperlink{struct__MOUNT__INFO_aeccc0a73a2a1f4d2a55cd938461bcd45}{rootOffset}     = (bootsector->\hyperlink{struct__BOOT__SECTOR_afedc563717fbacc0ce2e3b2fa31384bc}{Bpb}.
      \hyperlink{struct__BIOS__PARAMATER__BLOCK_a19dde0c3c6c8dd2d20ef53bc9dc71da8}{NumberOfFats} * bootsector->\hyperlink{struct__BOOT__SECTOR_afedc563717fbacc0ce2e3b2fa31384bc}{Bpb}.\hyperlink{struct__BIOS__PARAMATER__BLOCK_adc667cf101250030eb318e36b38487ea}{SectorsPerFat}) + 1;
353     \hyperlink{fat_8c_a48ba5e095fe5a8cbc25c65810d0460ee}{\_MountInfo}.\hyperlink{struct__MOUNT__INFO_afe78a775d2d21ba728ffb7df951c26a2}{rootSize}       = ( bootsector->\hyperlink{struct__BOOT__SECTOR_afedc563717fbacc0ce2e3b2fa31384bc}{Bpb}.
      \hyperlink{struct__BIOS__PARAMATER__BLOCK_a9d9f79e3acd72e08ff27fb471569c841}{NumDirEntries} * 32 ) / bootsector->\hyperlink{struct__BOOT__SECTOR_afedc563717fbacc0ce2e3b2fa31384bc}{Bpb}.\hyperlink{struct__BIOS__PARAMATER__BLOCK_a66104ad70bc3243f824e6d3a5203017d}{BytesPerSector};
354 \}
\end{DoxyCode}
\index{fat.\+h@{fat.\+h}!fsys\+Fat\+Open@{fsys\+Fat\+Open}}
\index{fsys\+Fat\+Open@{fsys\+Fat\+Open}!fat.\+h@{fat.\+h}}
\subsubsection[{\texorpdfstring{fsys\+Fat\+Open(const char $\ast$\+File\+Name)}{fsysFatOpen(const char *FileName)}}]{\setlength{\rightskip}{0pt plus 5cm}{\bf F\+I\+LE} fsys\+Fat\+Open (
\begin{DoxyParamCaption}
\item[{const char $\ast$}]{File\+Name}
\end{DoxyParamCaption}
)}\hypertarget{fat_8h_a3b2ffc78448b02fa4dda810701140f10}{}\label{fat_8h_a3b2ffc78448b02fa4dda810701140f10}
Opens a file any \textquotesingle{}\textbackslash{}\textquotesingle{}s in path?

nope, must be in root directory, search it

found file?

unable to find

go to next character after first \textquotesingle{}\textbackslash{}\textquotesingle{}

get pathname

if another \textquotesingle{}\textbackslash{}\textquotesingle{} or end of line is reached, we are done

copy character

open subdirectory or file

search root directory -\/ open pathname

search a subdirectory instead for pathname

found directory or file?

found file?

find next \textquotesingle{}\textbackslash{}\textquotesingle{}

unable to find 

Definition at line 259 of file fat.\+c.


\begin{DoxyCode}
259                                         \{
260 
261     \hyperlink{struct__FILE}{FILE} curDirectory;
262     \textcolor{keywordtype}{char}* p = 0;
263     \textcolor{keywordtype}{bool} rootDir=\textcolor{keyword}{true};
264     \textcolor{keywordtype}{char}* path = (\textcolor{keywordtype}{char}*) FileName;
265 \textcolor{comment}{}
266 \textcolor{comment}{    //! any '\(\backslash\)'s in path?}
267 \textcolor{comment}{}    p = \hyperlink{string_8h_a0d822829769975a03cfc4b9b2bc83895}{strchr} (path, \textcolor{charliteral}{'\(\backslash\)\(\backslash\)'});
268     \textcolor{keywordflow}{if} (!p) \{
269 \textcolor{comment}{}
270 \textcolor{comment}{        //! nope, must be in root directory, search it}
271 \textcolor{comment}{}        curDirectory = \hyperlink{fat_8c_a8acd9d04fdfc31b2e4b2e7c232d2b3be}{fsysFatDirectory} (path);
272 \textcolor{comment}{}
273 \textcolor{comment}{        //! found file?}
274 \textcolor{comment}{}        \textcolor{keywordflow}{if} (curDirectory.\hyperlink{struct__FILE_a04f8186df85989c0b4bcdb010c1f5bb6}{flags} == \hyperlink{vfs_8h_a20f0a7ade1270e3923abafeb33864c55}{FS\_FILE})
275             \textcolor{keywordflow}{return} curDirectory;
276 \textcolor{comment}{}
277 \textcolor{comment}{        //! unable to find}
278 \textcolor{comment}{}        \hyperlink{struct__FILE}{FILE} ret;
279         ret.\hyperlink{struct__FILE_a04f8186df85989c0b4bcdb010c1f5bb6}{flags} = \hyperlink{vfs_8h_a48368ff8647905d8be3aff007908c35a}{FS\_INVALID};
280         \textcolor{keywordflow}{return} ret;
281     \}
282 \textcolor{comment}{}
283 \textcolor{comment}{    //! go to next character after first '\(\backslash\)'}
284 \textcolor{comment}{}    p++;
285 
286     \textcolor{keywordflow}{while} ( p ) \{
287 \textcolor{comment}{}
288 \textcolor{comment}{        //! get pathname}
289 \textcolor{comment}{}        \textcolor{keywordtype}{char} pathname[16];
290         \textcolor{keywordtype}{int} i=0;
291         \textcolor{keywordflow}{for} (i=0; i<16; i++) \{
292 \textcolor{comment}{}
293 \textcolor{comment}{            //! if another '\(\backslash\)' or end of line is reached, we are done}
294 \textcolor{comment}{}            \textcolor{keywordflow}{if} (p[i]==\textcolor{charliteral}{'\(\backslash\)\(\backslash\)'} || p[i]==\textcolor{charliteral}{'\(\backslash\)0'})
295                 \textcolor{keywordflow}{break};
296 \textcolor{comment}{}
297 \textcolor{comment}{            //! copy character}
298 \textcolor{comment}{}            pathname[i]=p[i];
299         \}
300         pathname[i]=0; \textcolor{comment}{//null terminate}
301 \textcolor{comment}{}
302 \textcolor{comment}{        //! open subdirectory or file}
303 \textcolor{comment}{}        \textcolor{keywordflow}{if} (rootDir) \{
304 \textcolor{comment}{}
305 \textcolor{comment}{            //! search root directory - open pathname}
306 \textcolor{comment}{}            curDirectory = \hyperlink{fat_8c_a8acd9d04fdfc31b2e4b2e7c232d2b3be}{fsysFatDirectory} (pathname);
307             rootDir=\textcolor{keyword}{false};
308         \}
309         \textcolor{keywordflow}{else} \{
310 \textcolor{comment}{}
311 \textcolor{comment}{            //! search a subdirectory instead for pathname}
312 \textcolor{comment}{}            curDirectory = \hyperlink{fat_8c_aa5c8ff7ce941e32ad26c28794a3f022e}{fsysFatOpenSubDir} (curDirectory, pathname);
313         \}
314 \textcolor{comment}{}
315 \textcolor{comment}{        //! found directory or file?}
316 \textcolor{comment}{}        \textcolor{keywordflow}{if} (curDirectory.\hyperlink{struct__FILE_a04f8186df85989c0b4bcdb010c1f5bb6}{flags} == \hyperlink{vfs_8h_a48368ff8647905d8be3aff007908c35a}{FS\_INVALID})
317             \textcolor{keywordflow}{break};
318 \textcolor{comment}{}
319 \textcolor{comment}{        //! found file?}
320 \textcolor{comment}{}        \textcolor{keywordflow}{if} (curDirectory.\hyperlink{struct__FILE_a04f8186df85989c0b4bcdb010c1f5bb6}{flags} == \hyperlink{vfs_8h_a20f0a7ade1270e3923abafeb33864c55}{FS\_FILE})
321             \textcolor{keywordflow}{return} curDirectory;
322 \textcolor{comment}{}
323 \textcolor{comment}{        //! find next '\(\backslash\)'}
324 \textcolor{comment}{}        p=\hyperlink{string_8h_a0d822829769975a03cfc4b9b2bc83895}{strchr} (p+1, \textcolor{charliteral}{'\(\backslash\)\(\backslash\)'});
325         \textcolor{keywordflow}{if} (p)
326             p++;
327     \}
328 \textcolor{comment}{}
329 \textcolor{comment}{    //! unable to find}
330 \textcolor{comment}{}    \hyperlink{struct__FILE}{FILE} ret;
331     ret.\hyperlink{struct__FILE_a04f8186df85989c0b4bcdb010c1f5bb6}{flags} = \hyperlink{vfs_8h_a48368ff8647905d8be3aff007908c35a}{FS\_INVALID};
332     \textcolor{keywordflow}{return} ret;
333 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{fat_8h_a3b2ffc78448b02fa4dda810701140f10_cgraph}
\end{center}
\end{figure}


\index{fat.\+h@{fat.\+h}!fsys\+Fat\+Read@{fsys\+Fat\+Read}}
\index{fsys\+Fat\+Read@{fsys\+Fat\+Read}!fat.\+h@{fat.\+h}}
\subsubsection[{\texorpdfstring{fsys\+Fat\+Read(\+P\+F\+I\+L\+E file, unsigned char $\ast$\+Buffer, unsigned int Length)}{fsysFatRead(PFILE file, unsigned char *Buffer, unsigned int Length)}}]{\setlength{\rightskip}{0pt plus 5cm}void fsys\+Fat\+Read (
\begin{DoxyParamCaption}
\item[{{\bf P\+F\+I\+LE}}]{file, }
\item[{unsigned char $\ast$}]{Buffer, }
\item[{unsigned int}]{Length}
\end{DoxyParamCaption}
)}\hypertarget{fat_8h_a5be760edb30889bc597ea9ef5e81eb5a}{}\label{fat_8h_a5be760edb30889bc597ea9ef5e81eb5a}
Reads from a file starting physical sector

read in sector

copy block of memory

locate F\+AT sector

read 1st F\+AT sector

read 2nd F\+AT sector

read entry for next cluster

test if entry is odd or even

test for end of file

test for file corruption

set next cluster 

Definition at line 131 of file fat.\+c.


\begin{DoxyCode}
131                                                                          \{
132 
133     \textcolor{keywordflow}{if} (file) \{
134 \textcolor{comment}{}
135 \textcolor{comment}{        //! starting physical sector}
136 \textcolor{comment}{}        \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} physSector = 32 + (file->\hyperlink{struct__FILE_a01dafa6a663b0705884e39c397706874}{currentCluster} - 1);
137 \textcolor{comment}{}
138 \textcolor{comment}{        //! read in sector}
139 \textcolor{comment}{}        \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char}* sector = (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char}*) flpydsk\_read\_sector ( physSector );
140 \textcolor{comment}{}
141 \textcolor{comment}{        //! copy block of memory}
142 \textcolor{comment}{}        \hyperlink{string_8h_a776fdd36ddff3e9f4191ea47e0cbd5de}{memcpy} (Buffer, sector, 512);
143 \textcolor{comment}{}
144 \textcolor{comment}{        //! locate FAT sector}
145 \textcolor{comment}{}        \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} FAT\_Offset = file->\hyperlink{struct__FILE_a01dafa6a663b0705884e39c397706874}{currentCluster} + (file->
      \hyperlink{struct__FILE_a01dafa6a663b0705884e39c397706874}{currentCluster} / 2); \textcolor{comment}{//multiply by 1.5}
146         \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} FAT\_Sector = 1 + (FAT\_Offset / \hyperlink{fat_8c_aa35bad1e92008da628f27b2f6bb270aa}{SECTOR\_SIZE});
147         \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} entryOffset = FAT\_Offset % \hyperlink{fat_8c_aa35bad1e92008da628f27b2f6bb270aa}{SECTOR\_SIZE};
148 \textcolor{comment}{}
149 \textcolor{comment}{        //! read 1st FAT sector}
150 \textcolor{comment}{}        sector = (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char}*) flpydsk\_read\_sector ( FAT\_Sector );
151         \hyperlink{string_8h_a776fdd36ddff3e9f4191ea47e0cbd5de}{memcpy} (\hyperlink{fat_8c_a2ef8ac27e9545da20313a2f269705bc1}{FAT}, sector, 512);
152 \textcolor{comment}{}
153 \textcolor{comment}{        //! read 2nd FAT sector}
154 \textcolor{comment}{}        sector = (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{char}*) flpydsk\_read\_sector ( FAT\_Sector + 1 );
155         \hyperlink{string_8h_a776fdd36ddff3e9f4191ea47e0cbd5de}{memcpy} (\hyperlink{fat_8c_a2ef8ac27e9545da20313a2f269705bc1}{FAT} + \hyperlink{fat_8c_aa35bad1e92008da628f27b2f6bb270aa}{SECTOR\_SIZE}, sector, 512);
156 \textcolor{comment}{}
157 \textcolor{comment}{        //! read entry for next cluster}
158 \textcolor{comment}{}        uint16\_t nextCluster = *( uint16\_t*) &\hyperlink{fat_8c_a2ef8ac27e9545da20313a2f269705bc1}{FAT} [entryOffset];
159 \textcolor{comment}{}
160 \textcolor{comment}{        //! test if entry is odd or even}
161 \textcolor{comment}{}        \textcolor{keywordflow}{if}( file->\hyperlink{struct__FILE_a01dafa6a663b0705884e39c397706874}{currentCluster} & 0x0001 )
162             nextCluster >>= 4;      \textcolor{comment}{//grab high 12 bits}
163         \textcolor{keywordflow}{else}
164             nextCluster &= 0x0FFF;   \textcolor{comment}{//grab low 12 bits}
165 \textcolor{comment}{}
166 \textcolor{comment}{        //! test for end of file}
167 \textcolor{comment}{}        \textcolor{keywordflow}{if} ( nextCluster >= 0xff8) \{
168 
169             file->\hyperlink{struct__FILE_a9fece9dca128f88e081a2f9d879b5a70}{eof} = 1;
170             \textcolor{keywordflow}{return};
171         \}
172 \textcolor{comment}{}
173 \textcolor{comment}{        //! test for file corruption}
174 \textcolor{comment}{}        \textcolor{keywordflow}{if} ( nextCluster == 0 ) \{
175 
176             file->\hyperlink{struct__FILE_a9fece9dca128f88e081a2f9d879b5a70}{eof} = 1;
177             \textcolor{keywordflow}{return};
178         \}
179 \textcolor{comment}{}
180 \textcolor{comment}{        //! set next cluster}
181 \textcolor{comment}{}        file->\hyperlink{struct__FILE_a01dafa6a663b0705884e39c397706874}{currentCluster} = nextCluster;
182     \}
183 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=243pt]{fat_8h_a5be760edb30889bc597ea9ef5e81eb5a_cgraph}
\end{center}
\end{figure}


